#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#include <fcntl.h>
#include <sys/types.h> 
#include <sys/stat.h>

#include "../defs.h"
#include "./servidor_shmem.h"
#include "./servidorStruct.h"

int fdS;
request_t *reqS;
request_t *reqC;
request_t buf;
static sem_t *sd;

int 
createServerChannel(){
	
	
	if ( (fdS = shm_open(SERVER_NAME, O_RDWR|O_CREAT, 0666)) == -1 )
		fatal("sh_open");
	ftruncate(fdS, SIZE);
	if ( !(reqS = mmap(NULL, SIZE, PROT_READ|PROT_WRITE, MAP_SHARED, fdS, 0)) )
		fatal("mmap");
	close(fdS);
	reqC = reqS + 1;
	initmutex();
	reqS->reqID = EMPTY;
	reqC->reqID = EMPTY;

	return 0;

}

request_t 
receiveRequest(){
	int flag = 1;
	request_t request;

	while ( flag )
	{
		enter();
		if ( reqS->reqID != EMPTY )
		{
			printf("Servidor recibe: %d", reqS->reqID);
			memcpy(&request, reqS, sizeof request);
			reqS->reqID = EMPTY;
			flag = 0;
		}
		leave();
		sleep(1);
	}
	
	return request;
}

void 
sendRequest(request_t request){
	int flag = 1;
	printf("le envio al client: %d req: %d\n", request.PID, request.reqID);

	while(flag){
		enter();
		if(reqC->reqID == EMPTY ){
			reqC->price = request.price;
			memcpy(reqC, &request, sizeof request);
			flag = 0;
		}
		leave();
		sleep(1);
	}
}

int
createChannel(int clientPID){

	return OK;
}

int
closeChannel(){
	return OK;
}

int
closeCChannel(int pid){
	/*int i;
	for(i=0;i<MAX_USERS;i++){
		if(fifos[i].pid == pid){
			printf("cerrando canal: %d\n", fifos[i].fd);
			close(fifos[i].fd);
			fifos[i].pid = EMPTY;
			fifos[i].fd = 0;
		}
	}
	char Spid[20];
	sprintf(Spid, "%d\0", pid);
	char clientPath2[20] = CLIENT_NAME;
	char * clientPath = strcat(clientPath2, Spid);
	remove(clientPath);*/
	return OK;
}

void
enter(void)
{
	sem_wait(sd);
}

void
leave(void)
{
	sem_post(sd);
}


void
initmutex(void)
{
	if ( !(sd = sem_open(CLIENT_NAME, O_RDWR|O_CREAT, 0666, 1)) )
		fatal("sem_open");
}

void
fatal(char *s)
{
	perror(s);
	exit(1);
}

